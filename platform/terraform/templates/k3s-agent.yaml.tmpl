#cloud-config
write_files:
  - path: /etc/rancher/k3s/config.yaml
    permissions: "0600"
    content: |
      server: https://${control_plane_ip}:6443
      token: ${k3s_token}
%{ if length(agent_labels) > 0 ~}
      node-label:
%{ for label in agent_labels ~}
        - ${label}
%{ endfor ~}
%{ endif ~}
      flannel-backend: ${flannel_backend}
runcmd:
%{ if k3s_version != "" ~}
  - "curl -sfL ${k3s_install_url} | INSTALL_K3S_VERSION=${k3s_version} INSTALL_K3S_EXEC='agent' sh -"
%{ else ~}
  - "curl -sfL ${k3s_install_url} | INSTALL_K3S_EXEC='agent' sh -"
%{ endif ~}
