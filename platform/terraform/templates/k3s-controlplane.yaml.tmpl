#cloud-config
write_files:
  - path: /etc/rancher/k3s/config.yaml
    permissions: "0600"
    content: |
      token: ${k3s_token}
%{ if length(control_plane_tls_sans) > 0 ~}
      tls-san:
%{ for san in control_plane_tls_sans ~}
        - ${san}
%{ endfor ~}
%{ endif ~}
%{ if length(control_plane_taints) > 0 ~}
      node-taint:
%{ for taint in control_plane_taints ~}
        - ${taint}
%{ endfor ~}
%{ endif ~}
%{ if length(control_plane_labels) > 0 ~}
      node-label:
%{ for label in control_plane_labels ~}
        - ${label}
%{ endfor ~}
%{ endif ~}
%{ if length(disable_components) > 0 ~}
      disable:
%{ for component in disable_components ~}
        - ${component}
%{ endfor ~}
%{ endif ~}
      flannel-backend: ${flannel_backend}
runcmd:
%{ if k3s_version != "" ~}
  - "curl -sfL ${k3s_install_url} | INSTALL_K3S_VERSION=${k3s_version} INSTALL_K3S_EXEC='server' sh -"
%{ else ~}
  - "curl -sfL ${k3s_install_url} | INSTALL_K3S_EXEC='server' sh -"
%{ endif ~}
